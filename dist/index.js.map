{"version":3,"sources":["../src/index.js"],"names":["app","use","req","res","next","header","process","env","CORS_LIST","server","http","createServer","io","port","PORT","socket","token","handshake","query","data","success","user_id","user","emit","on","watsonInstance","sendMessage","text","then","output","result","generic","length","createSession","listen","console","log"],"mappings":";;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA,MAAMA,MAAM,wBAAZ;AACAA,IAAIC,GAAJ,CAAQ,UAASC,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AAC/BD,MAAIE,MAAJ,CAAW,6BAAX,EAA0CC,QAAQC,GAAR,CAAYC,SAAtD;AACAL,MAAIE,MAAJ,CAAW,kCAAX,EAA+C,MAA/C;AACAF,MAAIE,MAAJ,CAAW,8BAAX,EAA2C,2BAA3C;AACAF,MAAIE,MAAJ,CAAW,8BAAX,EAA2C,+DAA3C;AACAD;AACD,CAND;;AAQA,MAAMK,SAASC,eAAKC,YAAL,CAAkBX,GAAlB,CAAf;AACA,MAAMY,KAAK,sBAASH,MAAT,CAAX;AACA,MAAMI,OAAOP,QAAQC,GAAR,CAAYO,IAAZ,IAAoB,IAAjC;;AAEA;AACAF,GAAGX,GAAH,CAAO,OAAOc,MAAP,EAAeX,IAAf,KAAwB;AAC7B,QAAMY,QAAQD,OAAOE,SAAP,CAAiBC,KAAjB,CAAuBF,KAArC;AACA,QAAMG,OAAO,CAAC,MAAM,uBAAY,EAAEH,KAAF,EAAZ,CAAP,EAA+BG,IAA5C;AACA,MAAIA,KAAKC,OAAT,EAAkB;AAChBL,WAAOE,SAAP,CAAiBI,OAAjB,GAA2BF,KAAKA,IAAL,CAAUG,IAAV,CAAeD,OAA1C;AACA,WAAOjB,MAAP;AACD,GAHD,MAGO;AACLW,WAAOQ,IAAP,CAAY,QAAZ;AACD;AACF,CATD;;AAWAX,GAAGY,EAAH,CAAM,YAAN,EAAoB,UAAST,MAAT,EAAiB;AACnC,QAAMM,UAAUN,OAAOE,SAAP,CAAiBI,OAAjC;AACA,QAAMI,iBAAiB,uBAAvB;;AAEA,QAAMC,cAAc,CAAC,EAAEX,MAAF,EAAUU,cAAV,EAA0BE,IAA1B,EAAgCN,OAAhC,EAAD,KAA+C;AACjEI,mBAAeC,WAAf,CAA2B,EAAEC,IAAF,EAAQN,OAAR,EAA3B,EACGO,IADH,CACQzB,OAAO;AACX,YAAM0B,SAAS1B,IAAI2B,MAAJ,CAAWD,MAA1B;AACA,UAAIA,OAAOE,OAAP,CAAeC,MAAf,KAA0B,CAA9B,EAAiC;AAC/BjB,eAAOQ,IAAP,CAAY,SAAZ,EAAuB,oCAAvB;AACD,OAFD,MAEO;AACLR,eAAOQ,IAAP,CAAY,SAAZ,EAAuBM,OAAOE,OAAP,CAAe,CAAf,EAAkBJ,IAAzC;AACD;AACF,KARH;AASD,GAVD;;AAYAF,iBAAeQ,aAAf,GAA+BL,IAA/B,CAAoC,MAAM;AACxCF,gBAAY,EAAEC,MAAM,EAAR,EAAYF,cAAZ,EAA4BV,MAA5B,EAAoCM,OAApC,EAAZ;AACAN,WAAOS,EAAP,CAAU,SAAV,EAAsBG,IAAD,IAAU;AAC7BD,kBAAY,EAAEC,IAAF,EAAQF,cAAR,EAAwBV,MAAxB,EAAgCM,OAAhC,EAAZ;AACD,KAFD;AAGD,GALD;AAMD,CAtBD;;AAwBAZ,OAAOyB,MAAP,CAAcrB,IAAd,EAAoB,YAAW;AAC7BsB,UAAQC,GAAR,CAAa,kBAAiBvB,IAAK,EAAnC;AACD,CAFD","file":"index.js","sourcesContent":["import express from 'express';\nimport http from 'http';\nimport socketIO from 'socket.io';\nimport watson from '~/services/watson';\nimport { authorizate } from '~/services/auth';\n\nconst app = express();\napp.use(function(req, res, next) {\n  res.header(\"Access-Control-Allow-Origin\", process.env.CORS_LIST);\n  res.header(\"Access-Control-Allow-Credentials\", \"true\");\n  res.header(\"Access-Control-Allow-Methods\", \"GET,HEAD,OPTIONS,POST,PUT\");\n  res.header(\"Access-Control-Allow-Headers\", \"Origin, X-Requested-With, Content-Type, Accept, Authorization\");\n  next()\n})\n\nconst server = http.createServer(app);\nconst io = socketIO(server);\nconst port = process.env.PORT || 3000;\n\n// io.origins(process.env.CORS_LIST);\nio.use(async (socket, next) => {\n  const token = socket.handshake.query.token;\n  const data = (await authorizate({ token })).data;\n  if (data.success) {\n    socket.handshake.user_id = data.data.user.user_id\n    return next();\n  } else {\n    socket.emit('logout');\n  }\n});\n\nio.on('connection', function(socket) {\n  const user_id = socket.handshake.user_id;\n  const watsonInstance = watson();\n\n  const sendMessage = ({ socket, watsonInstance, text, user_id }) => {\n    watsonInstance.sendMessage({ text, user_id })\n      .then(res => {\n        const output = res.result.output;\n        if (output.generic.length === 0) {\n          socket.emit('message', 'Error ocurred, please contact devs');\n        } else {\n          socket.emit('message', output.generic[0].text);\n        }\n      });\n  }\n\n  watsonInstance.createSession().then(() => {\n    sendMessage({ text: '', watsonInstance, socket, user_id })\n    socket.on('message', (text) => {\n      sendMessage({ text, watsonInstance, socket, user_id })\n    });\n  });\n});\n\nserver.listen(port, function() {\n  console.log(`listening on *:${port}`);\n});\n"]}